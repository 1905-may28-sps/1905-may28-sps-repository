<!DOCTYPE html>
<html lang="en">
           <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <meta http-equiv="X-UA-Compatible" content="ie=edge">
                    <title>Document</title>
                    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
                        crossorigin="anonymous">
                    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
                        crossorigin="anonymous"></script>
                    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
                        crossorigin="anonymous"></script>
                    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
                        crossorigin="anonymous"></script>
                </head>
                
                <body>
                
                    
    <div class="jumbotron">
            <h1>Welcome to RevatureBank!</h1>
            <hr>
            <br>
            <div id="registrationForm">
                <h3>Register Below</h3>
                <input type="text"  id="firstname" placeholder="First Name" class="form-control col-4">
                <input type="text" id="lastname" placeholder="Last Name" class="form-control col-4">
                <input type="text" id="username" placeholder="Username" class="form-control col-4">
                <input type="password" id="password" placeholder="Password" class="form-control col-4">
                <button id="register" class="btn btn-submit" style="border: 2px navy solid">Register</button>
                
                <i id="goToLogin" style="text-decoration: underline">Already a user? Go to Login Form</i>
            </div>
    
            <div id="loginForm" hidden="true">
                    <h3>Log In</h3>
                    <input type="text" id="logUser" placeholder="Username" class="form-control col-4">
                    <input type="password" id="logPass" placeholder="Password" class="form-control col-4">
                    <button id="login" class="btn btn-submit" style="border: 2px navy solid">Login</button>    
            </div>
        </div>
        <hr>
                <span id="message"></span>
    
    
    <script>
window.onload = function(){
    //make an event listener for register button
    //call a function that obtains all fields from inputs
    //make an object with these fields. stringify it. print it to console
    document.getElementById('register').addEventListener('click', register);
    document.getElementById('username')
        .addEventListener('blur', validateUsername);
    document.getElementById('goToLogin').addEventListener('click', showLoginView );

}

function validateUsername(){
    var username = document.getElementById('username').value;
    /* Using AJAX -- we are going to send a get request
    to our JSON server to see if any users exist with the username 
    we know that if no user exists, our response body will be 
    an empty array, and if a user exists we will get back 
    an array with a user object
    */

    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function(){
        console.log(xhttp.readyState)
        if(xhttp.readyState == 4){
            //here, we can process response
            console.log(xhttp.status);
            var userArr = JSON.parse(xhttp.responseText);
            if(userArr.length == 0){
                //no user w username exists. we're good
                document.getElementById('message').innerHTML = '';
                document.getElementById('register').removeAttribute('disabled');
            }
            else{
                //username is taken. must let user know and disable our button
                document.getElementById('message').innerHTML = 
                    'Sorry, that username is taken! Please try again!';
                document.getElementById('register').setAttribute('disabled', "true");
            }
        }
    }
    xhttp.open("GET", `http://localhost:3000/users?username=${username}`);
    xhttp.send();

}

function register(){

    var userObj = {
        firstName : document.getElementById('firstname').value,
        lastName : document.getElementById('lastname').value,
        username: document.getElementById('username').value,
        password: document.getElementById('password').value
    }
    
    //validate that fields are not empty 
    var empty = false;
    for(let prop in userObj){
        if(userObj[prop] == null || userObj[prop].trim() == ''){
            empty = true;
            document.getElementById('message').innerHTML = 
            'Sorry, please fill out form completely';
        }
    }
    if(empty == false){
        //send request. and clear message field
        document.getElementById('message').innerHTML = '';

        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function(){
            // process response -- after we make sure the user was created, we go to a new page
            if(xhr.readyState == 4){
                console.log(xhr.status);
                showLoginView();
            }
        }

        xhr.open('POST', 'http://localhost:3000/users');

        xhr.setRequestHeader('Content-Type', 'application/json');

        //this send method is sending our user as a JSON string in the POST req body
        xhr.send(JSON.stringify(userObj));

    }
}

function showLoginView(){
    document.getElementById('registrationForm').remove();
    document.getElementById('loginForm').removeAttribute('hidden');
    //add listener for login button
    document.getElementById('login').addEventListener('click', login);
}

function login(){
    /*
    This function will retrieve user by username, then compare password 
    if no user w username exists, simply let user know theire credentials are invalid
    if user exists but pw doesnt match, do the same thing
    if user exists and password DOES match, console.log success, we will 
    later make a homepage for the user
    */

    //get username and password from input fields 
    //make sure fields are not empty 
    //send request to get user by username, then validate the user

    var name = document.getElementById('logUser').value;
    var pass = document.getElementById('logPass').value;

    if(name == null || name.trim() == '' || pass == null || pass.trim() == ''){
        // must fill out form, add message to dom
        document.getElementById('message').innerHTML = "must fill out form";

    }
    
    else{
        //send request 
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function(){
            if(xhr.readyState == 4){
                //get user 

                //validate to see if exists. if no, incorect login
                //if yes, check password
                var userArr=JSON.parse(xhr.responseText);
                if(userArr.length==0){
                    //no userfound
                    document.getElementById('message').innerHTML='Username does not exist please check again'
                }
                else if(userArr[0].password == document.getElementById('logPass').value){
                    console.log('login success');
                    alert(userArr[0].firstName + userArr[0].lastName)

                }
                else{document.getElementById('message').innerHTML="wrong pw"}
            }
        }

        xhr.open('GET', `http://localhost:3000/users?username=${name}`);

        xhr.send();


    }
}
</script>




</body>
</html>